#!/bin/sh

set -eu

VOLUMECTL_LIMIT="${VOLUMECTL_LIMIT:-1.3}"

getvol() {
	vol="$(wpctl get-volume @DEFAULT_AUDIO_SINK@)"
	[ -n "$vol" ] || return 1
	[ "$vol" != "${vol%\[MUTED\]}" ] && {
		echo "muted"
		return 0
	}
	numfmt --from-unit=100 --format="%.0f" "${vol#Volume: }"
}

case "${1:-get}" in
get)
	vol="$(getvol)" || exit $?
	echo "$vol%"
	;;
toggle)
	wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
	;;
mute)
	wpctl set-mute @DEFAULT_AUDIO_SINK@ 1
	;;
unmute)
	wpctl set-mute @DEFAULT_AUDIO_SINK@ 0
	;;
*+ | *- | *%)
	wpctl set-mute @DEFAULT_AUDIO_SINK@ 0
	wpctl set-volume @DEFAULT_AUDIO_SINK@ "$1" --limit "$VOLUMECTL_LIMIT"
	;;
mic)
	case "${2:-get}" in
	get)
		amixer get Capture
		;;
	mute)
		amixer -q set Capture nocap
		;;
	unmute)
		amixer -q set Capture cap
		;;
	toggle | cap | nocap)
		amixer -q set Capture "$2"
		;;
	*+ | *- | *%)
		amixer -q set Capture cap
		amixer -q set Capture "$2"
		;;
	*)
		echo "$(basename "$0"): $1: invalid subcommand: $2" >&2
		exit 1
		;;
	esac
	exit 0
	;;
*)
	echo "$(basename "$0"): invalid command: $1" >&2
	exit 1
	;;
esac

vol="$(getvol)" || exit $?
text="$vol%"
[ "$vol" = "muted" ] && {
	vol=0
	text="muted"
}
notify-send \
	-u low \
	-t 1000 \
	-a "$(basename "$0")" \
	-h "int:value:$vol" \
	-h "string:x-canonical-private-synchronous:volume" \
	"volume" \
	"$text"
