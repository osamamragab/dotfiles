#!/bin/sh

set -eu

export MENU_PROMPT="${MENU_PROMPT:-Menu}"

MENUS_DIR="${MENUS_DIR:-${XDG_DATA_HOME:-$HOME/.local/share}/menus}"
menus="$(
	cat <<-_EOF
		apps, Apps
		input, Input Handler
		recents, Recent Files
		clipboard, Clipboard History
		bookmarks, Bookmarks
		emojis, Emojis
		pass, Passwords
		pass-otp, Passwords OTP
		screenshot, Screenshot
		screenrec, Screen Recording
		power-profiles, Power Profiles
		display-profiles, Display Profiles
		sysact, Power Menu
	_EOF
)"

# TODO: remove tail pipe when https://codeberg.org/dnkl/fuzzel/issues/700 is fixed
menu="${1:-$(echo "$menus" | menu --nth-delimiter "," --with-nth 2 | tail -1)}" || exit 1
[ $# -gt 0 ] && {
	shift
	menu="$(echo "$menus" | grep "^$menu,")"
}

prompt="${menu#*,* }"
script="${menu%,*}"

[ -x "$MENUS_DIR/$script" ] || {
	echo "$(basename "$0"): invalid menu: $prompt ($script)" >&2
	exit 1
}

MENU_PROMPT="$prompt" exec "$MENUS_DIR/$script" "$@"
