#!/bin/sh

PROGRAMSDIR="${PROGRAMSDIR:-$HOME/programs}"
LOCALPROGRAMS="dwm st dmenu dwmblocks surf tabbed slock sent"
LOCALREPOS="https://gitlab.com/osamaragab/p.git https://github.com/jarun/nnn.git https://github.com/behdad/bicon.git https://github.com/LukeSmithxyz/mutt-wizard.git https://github.com/krpors/hx.git https://github.com/rupa/z.git https://github.com/pyenv/pyenv.git"

sudocmd="$(command -v doas 2>/dev/null || echo sudo)"
doas() { $sudocmd "$@"; }

ifinst() { command -v "$1" >/dev/null 2>&1; }

reponame() { basename "$1" | sed "s/\.git$//"; }

# params: repo_url, remote_name, remote_branch, [remote_url]
gitupdate() {
	dir="$PROGRAMSDIR/$(reponame "$1")"
	echo "updating $dir..."
	[ -d "$dir" ] || git clone "$1" "$dir"
	cd "$dir" || return 1
	[ "$4" ] && git remote add "$2" "$4" >/dev/null 2>&1
	ubr="${3:-$(git remote show origin | sed -n "/HEAD branch:/s/.* //p")}"
	git fetch "$2" "$ubr"
	git merge "$2/$ubr"
	[ -s .gitmodules ] && git submodule update --init --recursive
	return 0
}

makeinstall() {
	grep -q "^install:" Makefile || return 1
	echo "$@" | xargs "$sudocmd" make install || return 1
	grep -q "^clean:" Makefile && make clean
}

updatepkgs() {
	doas xbps-install -Syu
	ifinst rustup && rustup update
	ifinst bun && bun upgrade
	ifinst deno && deno upgrade
	ifinst pnpm && pnpm update -g
	ifinst gem && gem update
	ifinst sdk && sdk selfupdate && sdk update
	ifinst nvim && nvim --headless -c "autocmd User PackerComplete quitall" -c "PackerSync"
	ifinst flutter && flutter upgrade
	ifinst flatpak && flatpak update -y
	# ifinst pip && python3 -m pip install -U pip && pip list -o --format=freeze | grep -v "^\-e" | cut -d "=" -f 1  | xargs -n1 pip install -U
}

clean() {
	doas xbps-remove -Ooy
	doas vkpurge rm all
}

updatelocal() {
	for p in $LOCALPROGRAMS; do
		ubr="master"
		ure="git://git.suckless.org/$p"
		case "$p" in
			surf) ubr="surf-webkit2" ;;
			dwmblocks) ure="https://github.com/torrinfail/dwmblocks.git" ;;
		esac
		gitupdate "https://gitlab.com/osamaragab/$p.git" upstream "$ubr" "$ure" || continue
		[ -s Makefile ] && makeinstall
	done

	for r in $LOCALREPOS; do
		gitupdate "$r" origin || continue
		case "$(reponame "$r")" in
			nnn)
				[ -s Makefile ] && makeinstall O_NERD=1
				if [ -d "$PROGRAMS/nnn/plugins" ]; then
					plugdir="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/plugins"
					mkdir -p "$plugdir"
					for p in togglex nuke openall fzcd fzopen preview-tabbed gpge rsynccp upload; do
						cp -f "$PROGRAMSDIR/nnn/plugins/$p" "$plugdir/$p"
					done
				fi
				;;
			bicon)
				./autogen.sh && ./configure && make && doas make install
				;;
			z)
				doas cp -f "$PROGRAMSDIR/z/z.1" /usr/local/share/man/man1/z.1 &&
					doas chmod 644 /usr/local/share/man/man1/z.1
				;;
			pyenv)
				./src/configure &&
					make -C src &&
					doas ln -sf "$(readlink -f ./bin/pyenv)" /usr/local/bin
				;;
			*)
				[ -s Makefile ] && makeinstall
				;;
		esac
	done
}

for arg in "${@:-all}"; do
	case "$arg" in
		pkgs) updatepkgs ;;
		local) updatelocal ;;
		clean) clean ;;
		all)
			updatepkgs
			updatelocal
			clean
			;;
	esac
done
