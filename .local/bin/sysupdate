#!/bin/sh

set -eu

# shellcheck disable=SC2015
sudocmd="$([ -f /etc/doas.conf ] && command -v doas 2>/dev/null || command -v sudo 2>/dev/null)"

updatepkgs() {
	$sudocmd xbps-install -Sy &&
		$sudocmd xbps-install -uy xbps &&
		$sudocmd xbps-install -uy
	command -v nix >/dev/null 2>&1 &&
		nix-channel --update &&
		nix profile upgrade --all
	command -v flatpak >/dev/null 2>&1 &&
		flatpak update -y
	command -v xlocate >/dev/null 2>&1 &&
		xlocate -S
	# shellcheck disable=SC2086
	command -v makewhatis >/dev/null 2>&1 &&
		man -w | tr -d "\n" | xargs -d ":" $sudocmd makewhatis
	command -v xcheckrestart >/dev/null 2>&1 &&
		xcheckrestart
	return 0
}

clean() {
	$sudocmd xbps-remove -Ooy
	$sudocmd vkpurge rm all
	command -v nix >/dev/null 2>&1 && {
		nix-collect-garbage --delete-older-than 7d
		nix-store --optimise
	}
}

case "${1:-pkgs}" in
pkgs) updatepkgs ;;
clean) clean ;;
*)
	echo "$(basename "$0"): unknown command: $1" >&2
	exit 1
	;;
esac
