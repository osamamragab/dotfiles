#!/bin/sh

PROGRAMSDIR="${PROGRAMSDIR:-$HOME/programs}"
LOCALPROGRAMS="dwm st dmenu dwmblocks surf tabbed slock sent"
LOCALREPOS="git@github.com:LukeSmithxyz/mutt-wizard.git git@github.com:jarun/nnn.git git@github.com:krpors/hx.git git@github.com:rupa/z.git git@github.com:mariusae/trickle.git git@github.com:sumneko/lua-language-server.git git@github.com:elixir-lsp/elixir-ls.git"

sudocmd="$(command -v doas 2>/dev/null || echo sudo)"
doas() { $sudocmd "$@"; }

ifinst() { command -v "$1" >/dev/null 2>&1; }

reponame() { basename "$1" | sed "s/\.git$//"; }

gitupdate() {
	[ $# -eq 3 ] || (echo "$(basename "$0"): gitupdate: requires 3 arguments but got $#" >&2; return 1)
	url="$1"
	dir="$PROGRAMSDIR/$(reponame "$url")"
	# sre="$(echo "$2" | cut -d "/" -f 1)"
	sbr="$(echo "$2" | cut -d "/" -f 2)"
	ure="$(echo "$3" | cut -d "/" -f 1)"
	ubr="$(echo "$3" | cut -d "/" -f 2)"
	echo "updating $dir..."
	[ -d "$dir" ] || git clone "$url" "$dir"
	cd "$dir" || return 1
	git checkout "$sbr"
	git fetch "$ure" "$ubr"
	git merge "$ure/$ubr"
	[ -s .gitmodules ] && git submodule update --init --recursive
}

makeinstall() {
	if grep -q "^install:" Makefile; then
		echo "$@" | xargs "$sudocmd" make install || return 1
		grep -q "^clean:" Makefile && make clean
	fi
}

updatepkgs() {
	doas xbps-install -Syu
	ifinst rustup && rustup update
	ifinst deno && deno upgrade
	ifinst yarn && yarn global upgrade
	ifinst flatpak && flatpak update -y
	# ifinst pip && python3 -m pip install -U pip && pip list -o --format=freeze | grep -v "^\-e" | cut -d "=" -f 1  | xargs -n1 pip install -U
	# ifinst gem && gem update
	# ifinst flutter && flutter upgrade
	[ "$EDITOR" ] && ifinst "$EDITOR" &&
		case "$EDITOR" in
			vim) vim +PlugUpgrade +PlugUpdate +qa ;;
			nvim) nvim +PlugUpgrade +PlugUpdate +TSUpdateSync +qa ;;
		esac
}

clean() {
	doas xbps-remove -Ooy
	doas vkpurge rm all
}

updatelocal() {
	for p in $LOCALPROGRAMS; do
		ubr="master"
		ups="git://git.suckless.org/$p"
		case "$p" in
			surf) ubr="surf-webkit2" ;;
			dwmblocks) ups="git@github.com:torrinfail/dwmblocks.git" ;;
		esac
		git remote add upstream "$ups" >/dev/null 2>&1
		gitupdate "git@gitlab.com:osamai/$p.git" "origin/main" "upstream/$ubr"
		[ -s Makefile ] && makeinstall
	done

	for r in $LOCALREPOS; do
		gitupdate "$r" origin/master origin/master
		case "$(reponame "$r")" in
			nnn) [ -s Makefile ] && makeinstall O_NERD=1 ;;
			z)
				doas cp -f "$PROGRAMSDIR/z/z.1" /usr/local/share/man/man1/z.1 &&
					doas chmod 644 /usr/local/share/man/man1/z.1
				;;
			lua-language-server)
				cd 3rd/luamake &&
					./compile/install.sh &&
					cd ../.. &&
					./3rd/luamake/luamake rebuild
				;;
			elixir-ls)
				mix deps.get &&
					mix compile &&
					mix elixir_ls.release -o bin
				;;
			*) [ -s Makefile ] && makeinstall ;;
		esac
	done
}

for arg in "${@:-all}"; do
	case "$arg" in
		pkgs)  updatepkgs ;;
		local) updatelocal ;;
		clean) clean ;;
		all)
			updatepkgs
			updatelocal
			clean
			;;
	esac
done
