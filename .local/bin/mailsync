#!/bin/sh

set -eu

MAILDIR="${MAILDIR:-${XDG_DATA_HOME:-$HOME/.local/share}/mail}"
MBSYNCRC="${MBSYNCRC:-${XDG_CONFIG_HOME:-$HOME/.config}/isyncrc}"

sed -n "s/^User\s\(.*\)/\1/p" "$MBSYNCRC" | while IFS= read -r dir; do
	mkdir -p "$MAILDIR/$dir"
done

pidof -sqx mbsync && {
	echo "$(basename "$0"): already running" >&2
	exit 1
}

exec mbsync -aV
