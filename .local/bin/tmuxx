#!/bin/sh

CODEDIR="${CODEDIR:-$HOME/code}"

getdirs() {
	find "$1" -mindepth "${2:-1}" -maxdepth "${2:-1}" -type d | sed "s@$1/@@g"
}

sel="$1"
if [ -z "$sel" ] || [ "$sel" = "_" ]; then
	dirs="$(getdirs "$CODEDIR/projects" 1)\n$(getdirs "$CODEDIR/org" 2)"
	if [ -t 0 ]; then
		sel="$(echo "$dirs" | fzf)"
	else
		sel="$(echo "$dirs" | dmenu -i -F -fn monospace-12 -l 10 -p "project:")"
	fi
	[ -z "$sel" ] && exit 0
	[ -d "$CODEDIR/projects/$sel" ] && sel="$CODEDIR/projects/$sel"
	[ -d "$CODEDIR/org/$sel" ] && sel="$CODEDIR/org/$sel"
fi

if [ "$sel" = "." ]; then
	[ -t 0 ] || exit 1
	sel="$(pwd)"
fi

name="$(basename "$sel")"
tmux switchc -t "$name" 2>/dev/null && exit 0

if [ $# -gt 1 ]; then
	tmux new -d -c "$sel" -s "$name" -n "$2"
	shift
	while [ $# -gt 1 ]; do
		tmux neww -d -t "$name" -c "$sel" -n "$2"
		shift
	done
fi

if [ -t 0 ]; then
	tmux new -A -c "$sel" -s "$name"
else
	setsid -f "$TERMINAL" -t "$name" -e "$SHELL" -i -c "tmux new -A -c '$sel' -s '$name'"
fi
