#!/bin/sh

CODEDIR="${CODEDIR:-$HOME/code}"
[ -t 0 ] && USETERM=1 || USETERM=0

getdirs() {
	find "$1" -mindepth "${2:-1}" -maxdepth "${2:-1}" -type d | sed "s@$1/@@g"
}

projsel() {
	dirs="$(getdirs "$CODEDIR/projects" 1)\n$(getdirs "$CODEDIR/org" 2)"
	if [ "$USETERM" -eq 1 ]; then
		sel="$(echo "$dirs" | fzf)"
	else
		sel="$(echo "$dirs" | dmenu -i -F -fn monospace-12 -l 10 -p "project:")"
	fi
	[ -z "$sel" ] && return 1
	[ -d "$CODEDIR/projects/$sel" ] && echo "$CODEDIR/projects/$sel" && return 0
	[ -d "$CODEDIR/org/$sel" ] && echo "$CODEDIR/org/$sel" && return 0
}

case "$1" in
	"") sel="$(projsel)" ;;
	_)
		USETERM=1
		sel="$(projsel)"
		;;
	-)
		USETERM=0
		sel="$(projsel)"
		;;
	.)
		if [ "$USETERM" -eq 1 ]; then
			sel="$(pwd)"
		else
			sel="$(projsel)"
		fi
		;;
esac

[ -z "$sel" ] && exit 1

name="$(basename "$sel")"
tmux switchc -t "$name" 2>/dev/null && exit 0

if [ $# -gt 1 ]; then
	tmux new -d -c "$sel" -s "$name" -n "$2"
	shift
	while [ $# -gt 1 ]; do
		tmux neww -d -t "$name" -c "$sel" -n "$2"
		shift
	done
fi

if [ "$USETERM" -eq 1 ]; then
	tmux new -A -c "$sel" -s "$name"
else
	setsid -f "$TERMINAL" -t "$name" -e "$SHELL" -i -c "tmux new -A -c '$sel' -s '$name'"
fi
