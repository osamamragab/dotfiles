#!/bin/sh

set -eu

command -v qemu-system-x86_64 >/dev/null 2>&1 || {
	echo "$(basename "$0"): qemu-system-x86_64 not found" >&2
	exit 1
}

cpu=4
mem=4096
bios="/usr/share/qemu/bios.bin"
img=""
imgfmt=""

for arg; do
	case "$arg" in
		-cpu)
			shift
			cpu="$1"
			;;
		-mem)
			shift
			mem="$1"
			;;
		-efi)
			bios="/usr/share/ovmf/x64/OVMF.4m.fd"
			;;
		-bios)
			shift
			bios="$1"
			;;
		-f)
			shift
			imgfmt="$1"
			;;
		-c)
			shift
			conf="$(readlink -f "$1")"
			# shellcheck disable=1090
			[ -r "$conf" ] && . "$conf"
			;;
		--)
			shift
			break
			;;
		*)
			[ -n "${1:-}" ] && img="$1"
			;;
	esac
	[ $# -ne 0 ] && shift
done

[ -f "$img" ] || {
	echo "$(basename "$0"): $img: file not found" >&2
	exit 1
}

[ -n "$imgfmt" ] || {
	imgfmt="$(qemu-img info "$img" | sed -n "s/file format: \(.*\)/\1/p")" || exit 1
	imgext="${img##*.}"
	[ "$imgfmt" != "$imgext" ] && {
		printf "detected image format is \"%s\", [Y/n] or specify the format: " "$imgfmt"
		read -r p
		case "$p" in
			"" | Y | y | yes | Yes | YES) ;;
			N | n | no | No | NO) exit 1 ;;
			*) imgfmt="$p" ;;
		esac
	}
}

exec qemu-system-x86_64 \
	-enable-kvm \
	-cpu host \
	-smp "$cpu" \
	-m "$mem" \
	-machine vmport=off \
	-serial stdio \
	-vga virtio \
	-display sdl,gl=on \
	-audiodev pipewire,id=snd0 \
	-device ich9-intel-hda \
	-device hda-output,audiodev=snd0 \
	-boot menu=on,order=dc \
	-bios "$bios" \
	-drive format="$imgfmt",file="$img" \
	"$@"
