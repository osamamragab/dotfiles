#!/bin/sh

set -eu

slug=0
input=0

case "${1:-}" in
	slug)
		slug=1
		shift
		;;
	input)
		input=1
		shift
		;;
esac

[ -n "${MENU_PROMPT:-}" ] && {
	# shellcheck disable=SC2015
	[ $input -eq 1 ] &&
		set -- "$@" --prompt-only "$MENU_PROMPT> " ||
		set -- "$@" --prompt "$MENU_PROMPT> "
}

ec=0

sel="$(fuzzel -dR --no-sort "$@" 2>/dev/null)" ||
	case $? in
		1[0-9]) # custom exit codes
			ec=$?
			;;
		*)
			exit $?
			;;
	esac

# TODO: remove this when https://codeberg.org/dnkl/fuzzel/issues/700 is fixed
sel="$(echo "$sel" | tail -1)"

[ $slug -eq 1 ] && {
	sel="$(echo "$sel" | tr -dc "[:print:]" | tr "[:upper:][:space:][:punct:]" "[:lower:]-" | sed "s/-\+/-/g")"
	sel="${sel#-}"
	sel="${sel%-}"
}

echo "$sel"
exit $ec
