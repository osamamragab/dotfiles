#!/bin/sh

NOTESDIR="${NOTESDIR:-${XDG_DATA_HOME:-$HOME/.local/share}/notes}"
[ -d "$NOTESDIR" ] || mkdir -p "$NOTESDIR" || (echo "$(basename "$0"): can't create dir $NOTESDIR" >&2; exit 1)
cd "$NOTESDIR" || (echo "$(basename "$0"): can't cd to $NOTESDIR" >&2; exit 1)

lines=10

open() {
	if [ -t 0 ]; then
		$EDITOR "$1"
	else
		setsid -f "$TERMINAL" -e "$EDITOR" "$1"
	fi
}

case "$1" in
	-s)
		shift; [ $# -eq 0 ] && exit 1
		grep -Hnr "$@"
		exit 0
		;;
	-l)
		shift
		case "$1" in
			""|[!3-9]) echo "$(basename "$0"): lines must at least be 3" >&2; exit 1 ;;
		esac
		lines=$1
		shift
		;;
esac

if [ $# -eq 0 ]; then
	[ -t 0 ] && command -v fzy >/dev/null 2>&1 && menucmd="fzy -l $lines" || menucmd="dmenu -i -F -l $lines -p notes:"
	sel="$(find "$NOTESDIR" -type f -printf "%P\n" | $menucmd)" || exit $?
	[ "$sel" != "${sel#+}" ] && sel="${sel#+}"
	open "$NOTESDIR/${sel:-todo.md}"
	exit 0
fi

while [ $# -gt 0 ]; do
	case "$1" in
		*.txt | *.md) open "$NOTESDIR/$1" ;;
		*)
			if [ -d "$NOTESDIR/$1" ]; then
				NOTESDIR="$NOTESDIR/$1" "$0"
			elif [ -f "$NOTESDIR/$1.md" ]; then
				open "$NOTESDIR/$1.md"
			elif [ -f "$NOTESDIR/$1.txt" ]; then
				open "$NOTESDIR/$1.txt"
			else
				open "$NOTESDIR/$1"
			fi
			;;
	esac
	shift
done
