#!/bin/sh

HERE="$(dirname "$(readlink -f "$0")")"
. "$HERE/.config/shell/env"

PROGRAMSDIR="${PROGRAMSDIR:-$HOME/programs}"
[ -d "$PROGRAMSDIR" ] || mkdir -p "$PROGRAMSDIR"

echo "updating packages"
sudo xbps-install -Syu xbps
sudo xbps-install -Syu

echo "setting up dotfiles"
"$HERE/setup" dotfiles || { echo "setup dotfiles failed" >&2; exit 1; }

if ! command -v doas >/dev/null 2>&1; then
	echo "installing doas"
	sudo xbps-install -Sy opendoas
fi

alias xi="doas xbps-install -Sy"

echo "installing xorg & dependencies"
xi xorg-server xorg-input-drivers xauth xinit libX11-devel libXinerama-devel libXft-devel libXrandr-devel xset xsetroot xrandr xev fribidi-devel openssl-devel gcr-devel webkit2gtk-devel

echo "installing drivers & firmware"
xi mesa mesa-dri mesa-vdpau mesa-vaapi xf86-video-amdgpu xf86-video-intel linux-firmware intel-video-accel

echo "installing network tools"
xi dhcpcd wpa_supplicant ufw bluez bluez-alsa

echo "installing pipewire"
xi pipewire wireplumber pulsemixer libspa-bluetooth
doas cp -a /usr/share/pipewire /usr/share/wireplumber /etc

echo "installing general tools"
xi xtools xdg-utils xdg-user-dirs sxhkd xdotool xclip xsel xrdb xwallpaper xbanish xprop xss-lock xssstate picom dbus elogind acpilight wmname curl wget git patch rsync gnupg gnupg2 openssh pass pass-otp passmenu bc nq pv slop scrot dunst time entr mlocate nnn fzf ripgrep fd dust chrony scron libnotify darkhttpd yt-dlp bsdtar tar xz gzip bzip2 zstd zip unzip tlp earlyoom buku urlview dragon highlight redshift newsboat calcurse sc-im wiki-tui srm lftp hwinfo firejail farbfeld fribidi zbar qrencode mediainfo bat delta tig vsv clipmenu translate-shell screenkey duf direnv syncthing lz4jsoncat gnome-epub-thumbnailer

echo "installing manual pages"
xi man-pages man-pages-posix texinfo tealdeer

echo "installing text editor & shell"
xi vim neovim tmux zsh zsh-completions zsh-autosuggestions zsh-history-substring-search tree-sitter-devel

echo "installing multimedia tools"
xi ffmpeg ImageMagick exiftool mat2 qpdf gimp sox mpv nsxiv zathura mupdf zathura-pdf-mupdf zathura-ps zathura-djvu sioyek libwebp

echo "installing filesystems support"
xi fuse3 autofs exfat-utils fuse-sshfs mtpfs simple-mtpfs

echo "installing music players"
xi mpd mpc ncmpcpp cava

echo "installing email tools"
xi neomutt isync msmtp notmuch abook gettext

echo "installing system monitoring tools"
xi strace lm_sensors socklog-void htop nvtop iotop iftop powertop

echo "installing internet stuff"
xi firefox lynx w3m amfora weechat

echo "setting up firefox"
"$HERE/setup" firefox || { echo "setup firefox failed" >&2; exit 1; }

echo "installing tor and torrent tools"
xi tor transmission

echo "installing networking tools"
xi openbsd-netcat lsof ldns wireshark termshark socat websocat mitmproxy bettercap sqlmap xh wrk nemesis macchanger proxychains-ng

echo "installing markup & latex tools"
xi pandoc lowdown groff typst texlive-basic

echo "installing fonts, themes, icons"
xi fontconfig dejavu-fonts-ttf font-ibm-plex-otf amiri-font noto-fonts-emoji arc-theme adwaita-plus
doas ln -st /etc/fonts/conf.d/ /etc/fonts/conf.avail/10-scale-bitmap-fonts.conf /usr/share/fontconfig/conf.avail/70-no-bitmaps.conf
doas xbps-reconfigure -f fontconfig

echo "installing programming tools"
xi gcc llvm clang lld tcc nasm make meson pkgconf automake libtool zig rustup go python3 python3-pip python3-pipx python3-pipenv lua luarocks nodejs pnpm xxd gdb valgrind radare2 delve binutils upx jq cppcheck shellcheck tokei hyperfine nix docker docker-compose podman podman-compose dive jupyterlab
rustup-init -y --no-modify-path &&
	rustup default stable &&
	cargo install cargo-update cargo-info
go install honnef.co/go/tools/cmd/staticcheck@latest

echo "setting up runit services"
"$HERE/setup" runit || { echo "setup runit failed" >&2; exit 1; }

echo "installing local programs"
"$HERE/.local/bin/sysupdate" local || { echo "sysupdate script failed" >&2; exit 1; }

echo "changing shell"
chsh -s "$(which zsh)"
