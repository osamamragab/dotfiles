#!/bin/sh
# vim: wrap

HERE="$(dirname "$(readlink -f "$0")")"
. "$HERE/.config/shell/env"

PROGRAMSDIR="${PROGRAMSDIR:-$HOME/programs}"
[ -d "$PROGRAMSDIR" ] || mkdir -p "$PROGRAMSDIR"

echo "updating packages"
sudo xbps-install -Syu xbps
sudo xbps-install -Syu

if ! command -v doas >/dev/null 2>&1; then
	echo "installing doas"
	sudo xbps-install -Sy opendoas
	sudo cp -n "$HERE/.config/doas/doas.conf" /etc/doas.conf
fi

if [ -x "$HERE/setup" ]; then
	echo "running setup dotfiles script..."
	"$HERE/setup" dotfiles
fi

alias xi="doas xbps-install -Sy"

echo "installing xorg & dependencies"
xi xorg-server xorg-input-drivers xauth xinit libX11-devel libXinerama-devel libXft-devel libXrandr-devel xset xsetroot xev fribidi-devel openssl-devel gcr-devel webkit2gtk-devel

echo "installing drivers & firmware"
xi mesa mesa-dri mesa-vdpau mesa-vaapi xf86-video-amdgpu xf86-video-intel linux-firmware intel-video-accel

echo "installing network tools"
xi dhcpcd wpa_supplicant ufw bluez bluez-alsa macchanger

echo "installing pipewire"
xi pipewire wireplumber pulsemixer libspa-bluetooth
doas cp -a /usr/share/pipewire /usr/share/wireplumber /etc

echo "installing general tools"
xi xtools xdg-utils xdg-user-dirs sxhkd xdotool xclip xsel xrdb xwallpaper xbanish xprop xssstate acpilight wmname curl wget git patch rsync gnupg gnupg2 openssh pass pass-otp passmenu bc nq pv slop maim dunst time entr mlocate nnn fzy ripgrep fd dust ntp scron libnotify darkhttpd yt-dlp bsdtar tar xz gzip bzip2 zstd zip unzip tlp thermald earlyoom buku urlview dragon highlight redshift newsboat calcurse sc-im wiki-tui srm lftp hwinfo firejail fribidi zbar qrencode mediainfo bat delta tig vsv clipmenu translate-shell screenkey duf direnv lz4jsoncat gnome-epub-thumbnailer

echo "installing manual pages"
xi man-pages man-pages-posix texinfo tealdeer

echo "installing text editor & shell"
xi vim neovim tmux zsh zsh-completions zsh-autosuggestions zsh-history-substring-search

echo "installing multimedia tools"
xi ffmpeg ImageMagick qpdf gimp sox mpv nsxiv zathura mupdf zathura-pdf-mupdf zathura-ps zathura-djvu libwebp

echo "installing filesystems support"
xi fuse3 autofs exfat-utils fuse-sshfs mtpfs simple-mtpfs

echo "installing music players"
xi mpd mpc ncmpcpp

echo "installing email tools"
xi neomutt isync msmtp notmuch abook gettext

echo "installing system monitoring tools"
xi strace lm_sensors socklog-void htop nvtop iotop iftop

echo "installing internet stuff"
xi firefox tor lynx w3m amfora weechat
if [ -x "$HERE/setup" ]; then
	echo "running setup firefox script..."
	firefox --headless >/dev/null 2>&1 &
	sleep 1
	"$HERE/setup" firefox
	pkill firefox
fi

echo "installing torrent tools"
xi rtorrent transmission

echo "installing networking tools"
xi nmap openbsd-netcat lsof ldns wireshark termshark socat websocat mitmproxy bettercap sqlmap xh wrk nemesis

echo "installing markup & latex tools"
xi pandoc lowdown texlive-basic

echo "installing fonts, themes, icons"
xi dejavu-fonts-ttf font-ibm-plex-ttf amiri-font noto-fonts-emoji arc-theme adwaita-icon-theme adwaita-plus

echo "installing programming tools"
xi gcc llvm clang lld tcc nasm make meson pkgconf automake libtool zig rustup go python3 python3-pip python3-pipx python3-pipenv lua luarocks nodejs pnpm xxd gdb gef valgrind radare2 delve binutils upx jq cppcheck shellcheck tokei hyperfine nix docker docker-compose dive
rustup-init -y --no-modify-path &&
	rustup default stable &&
	cargo install cargo-update cargo-info
go install honnef.co/go/tools/cmd/staticcheck@latest

[ -x "$HERE/.local/bin/sysupdate" ] && "$HERE/.local/bin/sysupdate" local

echo "changing shell"
chsh -s "$(which zsh)"
