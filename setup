#!/bin/sh

set -eu

HERE="$(dirname "$(readlink -f "$0")")"
. "$HERE/.config/shell/env"

SETUP_PROGRAMS_DIR="${SETUP_PROGRAMS_DIR:-$HOME/programs}"
SETUP_PKGS_FILE="${SETUP_PKGS_FILE:-$XDG_DATA_HOME/meta/pkgs.txt}"
SETUP_PKGS_FLATPAKS_FILE="${SETUP_PKGS_FLATPAKS_FILE:-$XDG_DATA_HOME/meta/flatpaks.txt}"

[ -n "${SETUP_BROWSER_DIR:-}" ] || case "$BROWSER" in
	zen-browser) SETUP_BROWSER_DIR="$HOME/.zen" ;;
	librewolf) SETUP_BROWSER_DIR="$HOME/.librewolf" ;;
	waterfox) SETUP_BROWSER_DIR="$HOME/.waterfox" ;;
	firefox) SETUP_BROWSER_DIR="$HOME/.mozilla/firefox" ;;
	*)
		[ "$1" = "browser" ] || [ "$1" = "all" ] && {
			echo "$(basename "$0"): cannot determine SETUP_BROWSER_DIR" >&2
			exit 1
		}
		;;
esac

# shellcheck disable=2015
sudocmd="$([ -f /etc/doas.conf ] && command -v doas 2>/dev/null || command -v sudo 2>/dev/null)"

[ "$(id -u)" -eq 0 ] && {
	echo "$(basename "$0"): this script should not run as root" >&2
	exit 1
}

setup_dotfiles() {
	cp -srfvt "$HOME" "$HERE/.config" "$HERE/.local"
	ln -sfv "$XDG_CONFIG_HOME/shell/profile" "$HOME/.zprofile"
	$sudocmd cp -rfvt /etc "$HERE/etc/."
	$sudocmd mkdir -pv /var/cache/zsh
}

setup_pkgs() {
	$sudocmd xbps-install -Sy &&
		$sudocmd xbps-install -Suy xbps &&
		$sudocmd xbps-install -Suy
	[ -r "$SETUP_PKGS_FILE" ] &&
		xargs $sudocmd xbps-install -Sy <"$SETUP_PKGS_FILE"
	[ -r "$SETUP_PKGS_FLATPAKS_FILE" ] &&
		command -v flatpak >/dev/null 2>&1 &&
		flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo &&
		xargs flatpak install -y <"$SETUP_PKGS_FLATPAKS_FILE"
	command -v go >/dev/null 2>&1 &&
		go telemetry off
	command -v rustup >/dev/null 2>&1 &&
		rustup default stable &&
		cargo install cargo-update cargo-info
	command -v wine >/dev/null 2>&1 &&
		mkdir -pv "$WINEPREFIX"
}

setup_user() {
	chsh -s "$(which zsh)"
	$sudocmd usermod -aG video,audio,input,storage,optical,network,lp,scanner,dbus,docker,nixbld "$USER"
}

setup_runit() {
	$sudocmd rm -vf \
		/var/service/agetty-tty4 \
		/var/service/agetty-tty5 \
		/var/service/agetty-tty6 \
		/var/service/sshd \
		/var/service/acpid \
		/var/service/dhcpcd \
		/var/service/wpa_supplicant
	$sudocmd ln -svft /var/service \
		/etc/sv/socklog \
		/etc/sv/nanoklog \
		/etc/sv/dbus \
		/etc/sv/udevd \
		/etc/sv/chrony \
		/etc/sv/cronie \
		/etc/sv/elogind \
		/etc/sv/NetworkManager \
		/etc/sv/bluetoothd \
		/etc/sv/ufw \
		/etc/sv/tlp \
		/etc/sv/sshd \
		/etc/sv/cupsd \
		/etc/sv/docker
}

setup_ufw() {
	$sudocmd ufw default deny
	$sudocmd ufw allow from 192.168.0.0/24
	$sudocmd ufw limit ssh
}

setup_browser() {
	[ -d "$SETUP_BROWSER_DIR" ] || {
		$BROWSER --headless >/dev/null 2>&1 &
		ffpid=$!
		sleep 1
	}
	sed -n "/Default=.*\..*/s/.*=//p" "$SETUP_BROWSER_DIR/profiles.ini" |
		while IFS= read -r p; do
			cat "/usr/share/arkenfox-user.js/user.js" >"$SETUP_BROWSER_DIR/$p/user.js"
			browsers="firefox"
			# shellcheck disable=2015
			[ "$BROWSER" != "$browsers" ] && browsers="$browsers $BROWSER" || true
			for b in $browsers; do
				[ -r "$XDG_CONFIG_HOME/$b/user.js" ] &&
					cat "$XDG_CONFIG_HOME/$b/user.js" >>"$SETUP_BROWSER_DIR/$p/user.js"
				[ -d "$XDG_CONFIG_HOME/$b/chrome" ] &&
					cp -rvL "$XDG_CONFIG_HOME/$b/chrome" "$SETUP_BROWSER_DIR/$p"
			done
		done
	# shellcheck disable=2015
	[ -n "${ffpid:-}" ] && kill "$ffpid" || true
}

setup_install() {
	setup_dotfiles
	setup_pkgs
	setup_user
	setup_runit
	setup_ufw
	setup_browser
}

setup_uninstall() {
	find "$HERE/.config" "$HERE/.local" -type f |
		while IFS= read -r p; do
			f="${p#"$HERE/"}"
			# shellcheck disable=2015
			[ -L "$HOME/$f" ] &&
				[ "$HERE/$f" = "$(readlink -f "$HOME/$f")" ] ||
				continue
			rm -vf "$HOME/$f"
		done
	sed -n "/Default=.*\..*/s/.*=//p" "$SETUP_BROWSER_DIR/profiles.ini" |
		while IFS= read -r p; do
			# shellcheck disable=2015
			[ -r "$SETUP_BROWSER_DIR/$p/user.js" ] &&
				cat "/usr/share/arkenfox-user.js/user.js" "$XDG_CONFIG_HOME/firefox/user.js" "$XDG_CONFIG_HOME/$BROWSER/user.js" |
				cmp "$SETUP_BROWSER_DIR/$p/user.js" ||
				continue
			rm -vf "$SETUP_BROWSER_DIR/$p/user.js"
		done
}

case "${1:-dotfiles}" in
	install) setup_install ;;
	dotfiles) setup_dotfiles ;;
	pkgs) setup_pkgs ;;
	user) setup_user ;;
	runit) setup_runit ;;
	ufw) setup_ufw ;;
	browser) setup_browser ;;
	uninstall) setup_uninstall ;;
	*)
		echo "$(basename "$0"): unknown command: $1" >&2
		exit 1
		;;
esac
